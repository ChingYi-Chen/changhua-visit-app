# db.pyimport osimport sqlite3from pathlib import Pathdef get_db_path() -> Path:    """    DB_PATH:      - If env DB_PATH is set: use it      - Else: use ./data/local.db (create ./data if missing)    This is important on hosting platforms (e.g., Render) where the working dir can vary.    """    p = os.getenv("DB_PATH", "").strip()    if p:        return Path(p)    return Path("data") / "local.db"DB_PATH = get_db_path()def get_conn():    DB_PATH.parent.mkdir(parents=True, exist_ok=True)    conn = sqlite3.connect(DB_PATH.as_posix(), check_same_thread=False)    conn.row_factory = sqlite3.Row    return conndef _ensure_distance_cache_schema(cur: sqlite3.Cursor):    """    Standardize distance_cache schema to:      distance_cache(src, dst, meters, seconds, updated_at)    If an old/incompatible schema exists (e.g., key_a/key_b/dist_m/dur_s),    drop & recreate it safely (cache only).    """    # Does table exist?    cur.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='distance_cache'")    exists = cur.fetchone() is not None    if exists:        cur.execute("PRAGMA table_info(distance_cache)")        cols = [r[1] for r in cur.fetchall()]  # column names        need = {"src", "dst", "meters", "seconds"}        if not need.issubset(set(cols)):            # Old/incompatible cache table -> rebuild (safe)            cur.execute("DROP TABLE IF EXISTS distance_cache")    # Create standardized table    cur.execute("""    CREATE TABLE IF NOT EXISTS distance_cache (      src TEXT NOT NULL,      dst TEXT NOT NULL,      meters INTEGER,      seconds INTEGER,      updated_at TEXT DEFAULT CURRENT_TIMESTAMP,      PRIMARY KEY (src, dst)    )    """)def init_db():    conn = get_conn()    cur = conn.cursor()    cur.execute("""    CREATE TABLE IF NOT EXISTS users (      id INTEGER PRIMARY KEY AUTOINCREMENT,      username TEXT UNIQUE NOT NULL,      password_hash TEXT NOT NULL,      is_admin INTEGER DEFAULT 0,      created_at TEXT DEFAULT CURRENT_TIMESTAMP    )    """)    cur.execute("""    CREATE TABLE IF NOT EXISTS cases (      id INTEGER PRIMARY KEY AUTOINCREMENT,      user_id INTEGER NOT NULL,      case_id TEXT NOT NULL,      name TEXT NOT NULL,      address_raw TEXT,      address_fixed TEXT,      lat REAL,      lng REAL,      geo_status TEXT DEFAULT 'FAIL',      updated_at TEXT DEFAULT CURRENT_TIMESTAMP,      UNIQUE(user_id, case_id),      FOREIGN KEY(user_id) REFERENCES users(id)    )    """)    cur.execute("""    CREATE TABLE IF NOT EXISTS geocode_cache (      addr_norm TEXT PRIMARY KEY,      lat REAL,      lng REAL,      updated_at TEXT DEFAULT CURRENT_TIMESTAMP    )    """)    # âœ… Fix: rebuild distance_cache if schema mismatched    _ensure_distance_cache_schema(cur)    conn.commit()    conn.close()